# Инструкция по настройке Supabase Storage для хранения документов

## Обзор

Supabase Storage позволяет хранить файлы документов прямо в Supabase, чтобы пользователи могли скачивать их с сайта. Функциональность уже реализована в коде, нужно только настроить Storage в Supabase.

## Шаг 1: Создание Bucket в Supabase

1. Откройте **Supabase Dashboard**
2. Перейдите в раздел **Storage**
3. Нажмите **New bucket**
4. Заполните данные:
   - **Name**: `wedding-documents` (обязательно именно это имя!)
   - **Public bucket**: **ОТКЛЮЧИТЕ** (bucket должен быть приватным)
   - **File size limit**: можно оставить по умолчанию или установить нужный лимит (например, 10MB)
   - **Allowed MIME types**: можно оставить пустым или указать разрешенные типы (например: `application/pdf,image/*,application/msword`)
5. Нажмите **Create bucket**

## Шаг 2: Настройка политик доступа (RLS)

1. В Supabase Dashboard перейдите в **SQL Editor**
2. Откройте файл `scripts/setup_storage.sql`
3. Выполните скрипт (нажмите **Run**)

Этот скрипт создаст политики доступа, которые обеспечивают:
- ✅ Клиенты могут скачивать документы только для своих свадеб
- ✅ Организаторы могут загружать, обновлять и удалять документы для всех своих свадеб
- ✅ Организаторы могут скачивать документы для всех своих свадеб

## Шаг 3: Проверка настройки

После выполнения скрипта проверьте:

1. **Bucket создан**: В Storage должен быть bucket `wedding-documents`
2. **Политики применены**: В Storage -> Policies должны быть видны созданные политики
3. **Тестирование**: Попробуйте загрузить документ через интерфейс организатора

## Как это работает

### Загрузка документа (Организатор)

1. Организатор создает документ через форму
2. Выбирает файл для загрузки
3. Файл загружается в bucket `wedding-documents` по пути: `{wedding_id}/{timestamp}.{extension}`
4. В таблице `documents` создается запись с `file_path`, `file_size`, `mime_type`

### Скачивание документа (Клиент и Организатор)

1. При загрузке списка документов для каждого документа с `file_path` создается временная ссылка (signed URL)
2. Ссылка действительна 1 час
3. Пользователь может скачать файл по этой ссылке
4. При следующей загрузке списка документов создается новая ссылка

### Удаление документа (Организатор)

1. При удалении документа из базы данных
2. Файл также удаляется из Storage
3. Это предотвращает накопление неиспользуемых файлов

## Структура хранения

Файлы хранятся в следующей структуре:
```
wedding-documents/
  ├── {wedding_id_1}/
  │   ├── 1234567890.pdf
  │   ├── 1234567891.jpg
  │   └── 1234567892.docx
  ├── {wedding_id_2}/
  │   ├── 1234567893.pdf
  │   └── ...
```

## Безопасность

- ✅ Bucket приватный - доступ только через политики RLS
- ✅ Клиенты видят только документы своих свадеб
- ✅ Организаторы видят только документы своих свадеб
- ✅ Только организаторы могут загружать/удалять файлы
- ✅ Используются временные signed URLs для скачивания

## Ограничения

- Размер файла ограничен настройками bucket (по умолчанию 50MB в Supabase)
- Signed URLs действительны 1 час (можно изменить в коде)
- Файлы хранятся в формате: `{wedding_id}/{timestamp}.{extension}`

## Troubleshooting

### Ошибка: "Bucket not found"
**Причина**: Bucket `wedding-documents` не создан
**Решение**: Создайте bucket через Dashboard -> Storage

### Ошибка: "new row violates row-level security policy"
**Причина**: Политики доступа не настроены или настроены неправильно
**Решение**: Выполните скрипт `setup_storage.sql`

### Ошибка: "The resource already exists"
**Причина**: Политика уже существует
**Решение**: Удалите существующие политики и выполните скрипт заново, или используйте `CREATE POLICY IF NOT EXISTS` (если поддерживается)

### Файлы не загружаются
**Причины**:
- Bucket не создан
- Политики доступа не настроены
- Превышен лимит размера файла
- Неправильный MIME тип (если указаны ограничения)

**Решение**: Проверьте все вышеперечисленное

## Дополнительные настройки

### Изменение времени жизни signed URL

В файле `src/services/weddingService.ts` строка 272:
```typescript
.createSignedUrl(doc.file_path, 3600); // 3600 секунд = 1 час
```

Измените значение на нужное (в секундах).

### Ограничение типов файлов

При создании bucket можно указать разрешенные MIME типы:
- `application/pdf` - только PDF
- `image/*` - все изображения
- `application/pdf,image/*,application/msword` - PDF, изображения и Word документы

### Ограничение размера файла

В настройках bucket можно установить максимальный размер файла.

